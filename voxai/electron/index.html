<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>VoxAI</title>
  <style>
    body {
      background: #121212;
      color: #fff;
      font-family: sans-serif;
      padding: 1rem;
    }
    button {
      margin-right: 1rem;
      padding: 0.5rem 1rem;
      border: none;
      border-radius: 0.25rem;
      background: #444;
      color: #fff;
      cursor: pointer;
    }
    button.active { background: #0a84ff; }
    button:disabled { opacity: 0.5; cursor: default; }

    .card {
      background: #1e1e1e;
      padding: 1rem;
      margin-top: 1rem;
      border-radius: 0.5rem;
    }

    #intro {
      margin-bottom: 1rem;
    }

    #answerList {
      list-style-type: disc;
      margin-left: 1.5rem;
      padding: 0;
    }
    #answerList li + li {
      margin-top: 0.5rem;
    }
    #answerList strong {
      display: inline-block;
      min-width: 8rem;
    }
  </style>
</head>
<body>
  <h1>ðŸŽ§ VoxAI</h1>
  <button id="startBtn">Start</button>
  <button id="stopBtn">Stop</button>
  <button id="askBtn" disabled>Ask AI</button>

  <div class="card">
    <h3>Transcript</h3>
    <div id="transcript">...</div>
  </div>
  <div class="card">
    <h3>Answer</h3>
    <p id="intro">Waiting for inputâ€¦</p>
    <ul id="answerList"></ul>
  </div>

  <script>
    const { ipcRenderer } = require('electron');
    const startBtn   = document.getElementById('startBtn');
    const stopBtn    = document.getElementById('stopBtn');
    const askBtn     = document.getElementById('askBtn');
    const transcript = document.getElementById('transcript');
    const intro      = document.getElementById('intro');
    const list       = document.getElementById('answerList');

    let recording = false;
    let awaiting = false;
    let buffer = '';

    function updateButtons() {
      startBtn.classList.toggle('active', recording);
      stopBtn.classList.toggle('active', !recording && !awaiting);
      askBtn.disabled = awaiting || !transcript.textContent.trim();
    }

    startBtn.addEventListener('click', () => {
      if (recording) return;
      recording = true;
      ipcRenderer.send('to-python', 'START');
      updateButtons();
    });

    stopBtn.addEventListener('click', () => {
      if (!recording) return;
      recording = false;
      ipcRenderer.send('to-python', 'STOP');
      updateButtons();
    });

    askBtn.addEventListener('click', () => {
      if (awaiting) return;
      intro.textContent = '';
      list.innerHTML = '';
      buffer = '';
      awaiting = true;
      updateButtons();
      ipcRenderer.send('to-python', 'ASK::');
    });

    ipcRenderer.on('from-python', (_, raw) => {
      if (raw.startsWith('TRANSCRIBED::')) {
        transcript.textContent = raw.slice(13);
        updateButtons();
        return;
      }
      if (!raw.startsWith('CHUNK::')) return;
      const chunk = raw.slice(7);
      if (chunk === '[END]') {
        // full response in buffer
        const parts = buffer.trim()
          .split(/\n\s*\n/)             // split on blank lines
          .map(p => p.trim())
          .filter(p => p);
        // first part â†’ intro
        intro.textContent = parts.shift() || '';
        // remaining lines as bullets
        parts
          .join('\n')                  // reassemble
          .split(/\r?\n/)              // split on newlines
          .map(line => line.trim())
          .filter(line => line)
          .forEach(line => {
            // parse "**Heading:** description"
            const m = line.match(/^\*{0,2}(.+?)\*{0,2}[:\-]\s*(.+)$/);
            const heading = m ? m[1] : '';
            const desc    = m ? m[2] : line;
            const li = document.createElement('li');
            if (heading) {
              li.innerHTML = `<strong>${heading}</strong>: ${desc}`;
            } else {
              li.textContent = desc;
            }
            list.appendChild(li);
          });
        awaiting = false;
        updateButtons();
      } else {
        buffer += chunk;
      }
    });

    updateButtons();
  </script>
</body>
</html>
